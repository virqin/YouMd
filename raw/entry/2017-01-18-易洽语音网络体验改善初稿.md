---
layout: post
title: 易洽语音网络体验改善初稿
category: 总则
tags: [__admin,体验改进]
---
    
#易洽语音网络体验改善初稿


| 日期 | 版本号 | 内容 | 修改人员 |
| ---- |-----|----- | ------ |
| 2015-10-14 | 1.0.0 | 初稿| 姚静雅、李康 |
| 2015-10-23 | 1.0.1 | 文档需要量化标准，达到可具体验收的标准，因此需要修改 |姚静雅、李康|
| 2015-10-26 | 1.0.2 |动态缓存调整|李康|


## 一、易洽哑终端语音提示标准规则

###1.现有语音提示正常分类
* (1) 终端开机过程中，播报“欢迎使用易洽”
* (2) 开机后，启动易洽应用前，播报“搜索网络”
* (3) 启动易洽应用，并登陆成功后，播报“XXX已登陆”
* (4) 用户登陆成功后，会自动进入默认群组，无默认群组，在3秒钟之后，自动进入第一个群组，此时播报“进入群组XXX”
* (5) 调节音量键，播报“音量XX级”
* (6) 寻组模式情况下，调节切换群组键播报群组名称,“群组XXX”
* (7)  启动单呼模式，播报“进入单呼模式”
* (8) 退出单呼模式，播报“退出单呼模式”
* (9) 成员选择情况下，调节切换按键，播报当前成员的名称，如“jd011”
* (10) 查询剩余电量，播报“剩余电量75%”、“剩余电量50%”、“剩余电量25%”等
* (11) 查询当前用户名称，播报“当前用户XXX”
* (12) 查询当前群组，播报“当前群组XXX”
* (13) 广播类数据，文字广播，直接用tts播出，语音广播，直接播出语音数据 

###2.现有语音提示异常分类
* (1) 当无法连接网络时，播报“无数据网络连接”
* (2) 当连接服务器失败时，播报“无法连接”
* (3) 当终端开机后，在启动应用前，按PTT键，播报“搜索网络”
* (4) 当启动应用后，成功登陆前，按PTT键，播报“未登陆”
* (5) 登陆失败时，播报失败原因，如“账号不存在”，“账号密码错误”，“超出服务器”
* (6) 未配置账号和密码时，播报“请配置账号信息”
* (7) 当账号被踢掉时播报“账号在其它位置登陆”

###3.语音通知优先级调整
> 语音通知可分为三大类: 本机播报的通知，手动触发的通知，交互产生的通知。
详细分为六小类,优先级从高到低为（高优先级可打断低优先级语音）:
>(1)本机异常提示语音（如无数据网络连接）
>(2)广播通知播报（如文本广播）
>(3)状态通知类（如账号已在其它位置登陆）
>(4)主动操作类（如切换群组播报群组XXX）
>(5)本机提示语音（如搜索网络）
>(6)对讲语音

###4.现有语音提示的优化
* (1) 将终端开机时间从开机到登陆服务器时间缩短到20秒以内，同时，将开机后进入应用前的“搜索网络”语音提示去掉(此项需要联系阿乐卡进行沟通)
* (2) 进入群组的提示需要详细化，将进入群组分为单呼、组呼和紧急呼叫.

关于单呼 - - - -
> 现有终端在进入单呼模式后，如果没有进行任何操作，直接退出单呼模式，只会播报“退出单呼模式”,需要修改为“退出单呼模式，返回群组XXX”
> 现有终端在建立单呼时，呼叫方会播报“进入单呼模式”，“进入群组XXX“，被呼叫方只会播报”进入群组XXX“
> 需要将呼叫方的语音提示修改为”进入单呼模式“，”进入单呼XXX(被呼叫方用户名)“
> 需要将被呼叫方的语音提示改为”XXX(呼叫方用户名)单呼“

>  
>  单呼需要添加对语音server的标志位，通知服务器如果被呼叫方无法进入单呼，则直接返回失败,播报“单呼失败”

关于组呼 - - - -
> 呼叫方播报，“进入组呼群组XXX”, 被呼叫方成员播报“进入组呼群组XXX”

关于紧急呼叫 - - - -
> 呼叫方播报，”紧急呼叫XXX(被呼叫方)“，被呼叫方播报”XXX(呼叫方)紧急呼叫“

* (3) 当无法连接数据网络时，应播报具体原因。(需要底层建立PPP连接返回值作为参考)
> 如：手机号是否欠费，周边基站是否繁忙，是否只与服务器无法建立连接，是否此时终端无信号

* (4) 当登陆应用播报“无法连接”时，应播报具体无法连接原因。
>如无法从dns获取ip地址，无法从调度器查询到语音服务器地址，无法与语音服务器建立tcp连接等

* (5)当用户掉线时，现有播报为”无法连接“
> 应修改为播报当时终端连接不上服务器的具体原因，如信号弱，基站忙等原因



##二、统计信息
>为了收集原始数据，便于问题的追踪和改善，为售后提供可分析数据，需要对终端运行的环境、基础网络质量、语音质量和指令质量进行统计和上传。需要统计的具体信息包括以下几个方面：

1、环境
>账号、软件版本、终端型号、sim卡信息、接入点、网络制式、cpu内存占用率、基站信息、位置、信号强度

2、基础网络质量
>时延
>抖动
>丢包
>断线频率

3、语音质量
>起呼时延
>丢音、抖动、带宽占用
>语音有效负荷（一句话或一段时间）
>无语音数据达到

4、指令服务质量
>每条指令时延
>查询数据时带宽和流量
>断线频率




---------------------------------------------------
## 三、数据上报模块
> 数据上报模块负责将终端记录的各种信息，上报到平台端，用于后续的统计分析。
### 1.信息上报类型
- 状态信息上报
> 程序启动后立即上报，且只上报一次。此类上报主要是用于用户一次使用过程中一般不会发生改变的信息。例如用户的账号、终端型号、软件版本等
- 异常信息上报
> 程序发现有新的异常记录，在合适的时段上报（例如对讲空闲时段）。此类上报主要用于网络等异常信息，有助于及时发现问题。
- 统计信息上报
> 程序根据规则统计数据信息，在合适的时段上报（例如对讲空闲时段）。此类上报主要用于网络、语音以及指令服务指令的统计数据。
- 用户数据上报
> 程序根据规则统计用户行为操作相关数据，在合适的时段上报（例如对讲空闲时段）。例如：用户一段时间内切换群组的次数，电量播放次数等
- 服务信息上报
> 搜集与对讲相关的服务信息，在合适的时段上报（例如对讲空闲时段），主要用于分析对讲相关服务情况。例如基站信息。
### 2.信息上报规则
- 静态信息上报，程序启动后立即上报，且只需上报一次。
- 其他类型的上报信息，均采用空闲时段则立即上报的原则。
  -  空闲时段是指：用户未收听讲话，也未在发言状态。
- 除了静态信息外，其他类型信息以一分钟为周期将信息记录到本地文件。

## 
## 四、语音缓存调整模块

### 1. 现有问题
>现有对讲缓存数据较少，为缓存400ms语音数据，如果当对讲环境所处网络比较卡，将缓存消耗完毕后，如果后续语音数据还未到达，则会出现语音卡顿；如果网络情况一直不通畅，则在单次对讲期间，会多次出现语音卡顿，造成用户体验很差.
 
###2. 关键技术点
#### 动态调整语音缓存大小
- 根据终端接收语音的抖动，动态调整语音缓存大小，达到减少语音卡顿的目的。
- 基于终端目前的抖动计算方案，为抖动值增加根据时间回归的属性。
-  回归属性是指，随着时间推移，在特定时间内抖动值恢复到默认值（3200,两个语音包，400ms）.
- 根据新的计算方案得出的抖动，动态调整语音缓存大小。
- 语音缓存大小应控制在2个语音包~测试产生的合适上限


### 3. 更新后产生的优化
> 当收听方所处网络环境较差，在播放所受到的语音出现多次卡顿时，会在下一次播放收听到的语音时，自动增大缓存即缓存语音数据的时间，以保证后续语音播放的整体流畅性。

 
### 4. 优化后可能产生的问题
 > 动态调整语音缓存，会造成语音延迟，当收听者网络环境差，会根据规则自动增大语音缓存，从而会造成语音播放的时延，
 > 当收听者网络环境恢复后，会再根据规则自动减小语音缓存。
 > 在自动调整的这段时间，用户可能会感知到语音时延较大。
 
 
### 5.量化标准
#### 现有终端网络卡顿情况下，语音卡顿概率
|特定环境|终端型号 |软件版本号|对讲次数 |语音出现卡顿次数|
|-------|-------|---------|-------|----------------|

#### 优化后对讲收听出现卡顿概率，及当次抖动时延
|特定环境|终端型号|软件版本号|讲话时长 |收听方卡顿情况严重程度 |当次抖动时延|
|-------|-------|---------|-------|-------|




## 五、会话管理模块
### 1. 用户需求
- 减少终端掉线次数
> 在某些情况下（尤其是网络较差）， 用户感知终端的掉线次数偏多。同样环境下，自有品牌终端掉线次数明显多于竞争对手终端。
 
### 2. 关键技术点
#### 提示优化
> 终端不是每次掉线都立即通知用户，使用延迟或者忽略策略减少掉线提示。

可采用方法：
- 掉线不再主动提示；只有当用户发起与服务端的交互操作时，再提示用户
- 掉线后不立即通知用户，而是重连超时后，再提示用户
- 掉线提示：采用更加准确的提示，如请检查手机信号等，优化用户体验

### 3. 优化后保证的技术指标
> 同样环境下，掉线率不高于竞争对手（卓志达）
 
#### 目前掉线率统计
> 参考资料：《网络稳定性测试报告20150813》
|信号强度|终端型号|软件版本号|掉线次数|每次掉线提示|每次恢复提示|每次恢复重连次数|每次恢复重连时间 |
|-------|-------|---------|-------|-------|-------|----|------|-----|

#### 优化后掉线率统计
|信号强度|终端型号|软件版本号|掉线次数|每次掉线提示|每次恢复提示|每次恢复重连次数|每次恢复重连时间 |
|-------|-------|---------|-------|-------|-------|----|------|-----|

### 4. 其他问题
#### 测试申请
> 开发任务《会话管理模块》目标为参照卓志达终端的表现，减少用户掉线次数，改善用户掉线恢复体验。  开发者需要在不同级别网络环境下，现有GD83终端与卓志达终端的掉线频率以及掉线恢复情况的测试结果，用于制定相关的开发计划。

现申请在不同级别网络环境下，对GD83终端与卓志达终端的掉线频率以及掉线恢复情况进行测试，统计出相关数据。
- 测试统计详细设计方案
- 测试结果统计报告
- 建议测试项
|信号强度|终端型号|软件版本号|掉线次数|每次掉线提示|每次恢复提示|每次恢复重连次数|每次恢复重连时间 |
|-------|-------|---------|-------|-------|-------|----|------|-----|
  


##  六、呼叫指令优化模块

>优化现有呼叫指令，指令扩展为普通群组呼叫、单呼、紧急呼叫；呼叫通知加入发起人以及呼叫群组类型。

### 1.现有问题
> 现有呼叫模式中只有普通群组呼叫和单呼,
> 对于发起呼叫者，进入普通群组和单呼群组时，播报的提示音没有加以区分，播报内容都为“进入群组XXX”
> 对于被呼叫者，播报内容为“进入群组XXX”，不能将被调入临时群组与进入普通群组以及进入单呼群组区分开
> 播报的提示音的准确度欠妥。
> 
### 2.方法
- 原有规则
  - 单呼失败
      - 发起呼叫用户不在任何单位中
      - 发起呼叫者在临时群组，则呼叫失败
  - 创建临时群组成员调入规则
     - 在线被呼叫者，进入临时群组
     - 用户不在任何群组
     - 用户在非临时群组中，且并未发言
     - 用户在线，属于被调度范围
- 新规则
  - 呼叫类型
     - 普通群组呼叫 ： 群组内成员数量任意
     - 单呼：被呼叫者有且只有一个用户
     - 紧急呼叫：是否要求调度员权限
  - 单呼失败
      - 增加：要求所呼叫用户在线且可以进入单呼群组，否则服务器直接返回单呼失败
      - 发起呼叫者在临时群组，则呼叫失败
  - 创建临时群组
     - 在线被呼叫者，进入临时群组
     - 限制：处在紧急呼叫状态的用户不受此规则限制 
     
###3. 关键技术点
#### 服务器对群组类型分类
> 客户端上报群组类型给服务器，服务器下发给被呼叫者。
> 呼叫者根据呼叫类型进行语音提示.

###4. 更新后产生的优化
> 对于普通群组呼叫：进入普通群组，语音提示为“进入群组XXX”
> 对于单呼: 呼叫者以及被呼叫者，语音提示均为“进入单呼XXX”;
				   >  且服务器应先判断当被呼叫者无法进入单呼群组时，直接返回失败
> 对于紧急呼叫：呼叫者以及被呼叫者，语音提示均为“紧急呼叫XXX”
     

## 七、抢麦放麦指令传输方式TCP转换UDP模块
### 1. 现有问题
> 公版库中抢麦放麦指令原来采用的是TCP传输方式，而语音数据使用的UDP传输方式，
> TCP传输方式的特性为不丢包，UDP传输方式的可能丢包。
> 在终端通过基站传输指令时，如果遇到网络拥堵或者基站忙的情况，使用TCP方式可能造成数据包在某一个环节长时间的延迟，极端情况为，当收听者所处基站出在忙碌状态，抢麦者发出的TCP指令数据包和UDP语音数据包，在到达收听着所处基站后，因为此基站忙，在较短时间内，UDP包被认为超时，被丢弃，而TCP指令数据包会被缓存，待到基站为空闲状态时，TCP抢麦放麦指令会被下放到收听着。
> 如果此基站不能提供服务的忙碌时间较长，如2分钟， 则会造成收听者，在2分钟后终端播报抢麦放麦提示音，而没有任何语音数据的情况.
 
###2. 关键技术点
#### 指令传输方式优化
> 将抢麦放麦指令传输方式由TCP改为UDP。

#### 新旧终端兼容
- 新版终端通过UDP发送、接收抢麦放麦指令，旧版终端通过TCP发送、接收抢麦放麦指令，服务端需要对转发做到兼容。

### 3. 更新后产生的优化
> 抢麦放麦传输传输方式优化后，在收听者所处基站忙碌时，会造成UDP指令数据包如果在短时间内未到达，则被丢弃，改善用户体验

 
### 4. 优化后可能产生的问题
 > 当讲话者发出的抢麦UDP数据包丢失后，可能会造成收听者不能收到有人讲话的通知，进而不能播放出讲话者的语音。
 > 当讲话则发出的放麦UDP数据包丢失后，可能会造成收听者不能收到讲话者放麦的通知，进而一直播放底噪，不能中断讲话者的语音。

### 5.量化标准 
#### 目前对讲说话只能收到抢麦放麦提示音概率统计
|特定环境|终端型号 |软件版本号|对讲次数 |有抢麦音无语音次数|
|-------|-------|---------|-------|----------------|

#### 优化后对讲说话收发正常概率统计
|特定环境|终端型号|软件版本号|讲话次数 |成功播放抢麦提示音次数|成功播放语音次数|成功播放放麦提示音次数|
|-------|-------|---------|-------|-------|